<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Data Organizer</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .section-hidden {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        
        .section-visible {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: slideIn 0.4s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .visit-type-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .visit-type-card:hover {
            border-color: #0d6efd;
            transform: translateY(-2px);
        }
        
        .visit-type-card.selected {
            border-color: #0d6efd;
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.1), rgba(13, 110, 253, 0.05));
        }
        
        .image-upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .image-upload-item {
            position: relative;
            border: 2px dashed #6c757d;
            border-radius: 8px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(108, 117, 125, 0.1);
        }
        
        .image-upload-item:hover {
            border-color: #0d6efd;
            background: rgba(13, 110, 253, 0.1);
        }
        
        .image-upload-item.has-image {
            border-color: #198754;
            background: rgba(25, 135, 84, 0.1);
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 80px;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .step {
            display: flex;
            align-items: center;
            color: #6c757d;
        }
        
        .step.active {
            color: #0d6efd;
        }
        
        .step.completed {
            color: #198754;
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .step.active .step-number,
        .step.completed .step-number {
            background: currentColor;
            color: white;
        }
        
        .step-connector {
            width: 60px;
            height: 2px;
            background: #6c757d;
            margin: 0 1rem;
        }
        
        .step.completed + .step .step-connector {
            background: #198754;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark border-bottom">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{{ url_for('index') }}">
                <i class="bi bi-file-medical me-2"></i>Patient Data Organizer
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="{{ url_for('index') }}">
                    <i class="bi bi-plus-circle me-1"></i>New Case
                </a>
                <a class="nav-link" href="{{ url_for('patient_list') }}">
                    <i class="bi bi-people me-1"></i>Patients
                </a>
                <a class="nav-link" href="{{ url_for('cases') }}">
                    <i class="bi bi-folder me-1"></i>Case History
                </a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold mb-3">Patient Data Organizer</h1>
            <p class="lead text-muted">Create professional medical case presentations</p>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <span>Visit Type</span>
            </div>
            <div class="step-connector"></div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <span>Patient Info</span>
            </div>
            <div class="step-connector"></div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <span>Case Details</span>
            </div>
            <div class="step-connector"></div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <span>Images</span>
            </div>
        </div>

        <!-- Main Form -->
        <form action="{{ url_for('upload_files') }}" method="post" enctype="multipart/form-data" id="mainForm">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    
                    <!-- Step 1: Visit Type Selection -->
                    <div class="card border-0 bg-dark mb-4" id="visitTypeSection">
                        <div class="card-body">
                            <h4 class="card-title mb-4 text-center">
                                <i class="bi bi-clipboard-check me-2"></i>Select Visit Type
                            </h4>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="visit-type-card card h-100 text-center p-4" onclick="selectVisitType('registration')">
                                        <div class="card-body">
                                            <i class="bi bi-person-plus display-4 text-primary mb-3"></i>
                                            <h5 class="card-title">Registration</h5>
                                            <p class="card-text text-muted">New patient registration with complete documentation</p>
                                            <input type="radio" name="visit_type" value="registration" class="d-none" id="registration">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="visit-type-card card h-100 text-center p-4" onclick="selectVisitType('orthodontic_visit')">
                                        <div class="card-body">
                                            <i class="bi bi-calendar-check display-4 text-success mb-3"></i>
                                            <h5 class="card-title">Orthodontic Visit</h5>
                                            <p class="card-text text-muted">Follow-up visit progress documentation</p>
                                            <input type="radio" name="visit_type" value="orthodontic_visit" class="d-none" id="orthodontic_visit">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="visit-type-card card h-100 text-center p-4" onclick="selectVisitType('debond')">
                                        <div class="card-body">
                                            <i class="bi bi-check-circle display-4 text-warning mb-3"></i>
                                            <h5 class="card-title">Debond</h5>
                                            <p class="card-text text-muted">Treatment completion and final results</p>
                                            <input type="radio" name="visit_type" value="debond" class="d-none" id="debond">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Patient Information -->
                    <div class="section-hidden" id="patientSection">
                        <!-- Registration Fields -->
                        <div class="card border-0 bg-dark mb-4" id="registrationFields">
                            <div class="card-body">
                                <h4 class="card-title mb-4">
                                    <i class="bi bi-person-plus me-2"></i>New Patient Registration
                                </h4>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="mrn" class="form-label">Medical Record Number (MRN) *</label>
                                        <input type="text" class="form-control" id="mrn" name="mrn" placeholder="Enter MRN...">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="clinic" class="form-label">Clinic *</label>
                                        <select class="form-select" id="clinic" name="clinic">
                                            <option value="">Select clinic...</option>
                                            <option value="KFMC">KFMC</option>
                                            <option value="DC">DC</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="firstName" class="form-label">First Name *</label>
                                        <input type="text" class="form-control" id="firstName" name="first_name" placeholder="Enter first name...">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="lastName" class="form-label">Last Name *</label>
                                        <input type="text" class="form-control" id="lastName" name="last_name" placeholder="Enter last name...">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Follow-up Visit Fields -->
                        <div class="card border-0 bg-dark mb-4" id="followupFields" style="display: none;">
                            <div class="card-body">
                                <h4 class="card-title mb-4">
                                    <i class="bi bi-search me-2"></i>Find Existing Patient
                                </h4>
                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <label for="mrnSearch" class="form-label">Search by MRN *</label>
                                        <input type="text" class="form-control" id="mrnSearch" name="mrn_search" placeholder="Enter MRN to search..." oninput="searchPatients()">
                                        <div id="searchResults" class="mt-2"></div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="button" class="btn btn-outline-secondary w-100" onclick="clearSearch()">
                                            <i class="bi bi-x-circle me-1"></i>Clear Search
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" id="selectedPatientId" name="patient_id">
                                <div id="selectedPatientInfo" class="mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="bi bi-person-check me-2"></i>
                                        <strong>Selected Patient:</strong> <span id="selectedPatientDetails"></span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="visitDescription" class="form-label">Visit Description</label>
                                    <textarea class="form-control" id="visitDescription" name="visit_description" rows="3" placeholder="Describe the visit details..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Case Details -->
                    <div class="section-hidden" id="caseDetailsSection">
                        <div class="card border-0 bg-dark mb-4">
                            <div class="card-body">
                                <h4 class="card-title mb-4">
                                    <i class="bi bi-file-text me-2"></i>Case Information
                                </h4>
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <label for="title" class="form-label">Case Title *</label>
                                        <input type="text" class="form-control" id="title" name="title" placeholder="Enter descriptive case title..." required>
                                    </div>
                                    <div class="col-12 mb-3">
                                        <label for="notes" class="form-label">Case Notes</label>
                                        <textarea class="form-control" id="notes" name="notes" rows="4" placeholder="Enter detailed case notes, observations, and treatment plan..."></textarea>
                                        <div class="form-text">
                                            <span id="noteCount">0</span>/500 characters
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Image Upload -->
                    <div class="section-hidden" id="imageUploadSection">
                        <!-- Extra-oral Images -->
                        <div class="card border-0 bg-dark mb-4">
                            <div class="card-body">
                                <h4 class="card-title mb-4">
                                    <i class="bi bi-camera me-2"></i>Extra-oral Images
                                </h4>
                                <div class="image-upload-grid">
                                    <div class="image-upload-item" onclick="triggerFileInput('eofv')">
                                        <i class="bi bi-camera display-6 text-muted mb-2"></i>
                                        <div class="text-center">
                                            <strong>Front View</strong>
                                            <div class="text-muted small">Extra-oral Front</div>
                                        </div>
                                        <input type="file" id="eofv" name="eofv" accept="image/*" class="d-none" onchange="handleImageUpload(this, 'eofv')">
                                    </div>
                                    <div class="image-upload-item" onclick="triggerFileInput('eosv')">
                                        <i class="bi bi-camera display-6 text-muted mb-2"></i>
                                        <div class="text-center">
                                            <strong>Side View</strong>
                                            <div class="text-muted small">Extra-oral Side</div>
                                        </div>
                                        <input type="file" id="eosv" name="eosv" accept="image/*" class="d-none" onchange="handleImageUpload(this, 'eosv')">
                                    </div>
                                    <div class="image-upload-item" onclick="triggerFileInput('eomv')">
                                        <i class="bi bi-camera display-6 text-muted mb-2"></i>
                                        <div class="text-center">
                                            <strong>Smile View</strong>
                                            <div class="text-muted small">Extra-oral Smile</div>
                                        </div>
                                        <input type="file" id="eomv" name="eomv" accept="image/*" class="d-none" onchange="handleImageUpload(this, 'eomv')">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Intra-oral Images -->
                        <div class="card border-0 bg-dark mb-4">
                            <div class="card-body">
                                <h4 class="card-title mb-4">
                                    <i class="bi bi-camera-fill me-2"></i>Intra-oral Images
                                </h4>
                                <div class="image-upload-grid">
                                    <div class="image-upload-item" onclick="triggerFileInput('iorv')">
                                        <i class="bi bi-camera display-6 text-muted mb-2"></i>
                                        <div class="text-center">
                                            <strong>Right View</strong>
                                            <div class="text-muted small">Intra-oral Right</div>
                                        </div>
                                        <input type="file" id="iorv" name="iorv" accept="image/*" class="d-none" onchange="handleImageUpload(this, 'iorv')">
                                    </div>
                                    <div class="image-upload-item" onclick="triggerFileInput('iofv')">
                                        <i class="bi bi-camera display-6 text-muted mb-2"></i>
                                        <div class="text-center">
                                            <strong>Front View</strong>
                                            <div class="text-muted small">Intra-oral Front</div>
                                        </div>
                                        <input type="file" id="iofv" name="iofv" accept="image/*" class="d-none" onchange="handleImageUpload(this, 'iofv')">
                                    </div>
                                    <div class="image-upload-item" onclick="triggerFileInput('iolv')">
                                        <i class="bi bi-camera display-6 text-muted mb-2"></i>
                                        <div class="text-center">
                                            <strong>Left View</strong>
                                            <div class="text-muted small">Intra-oral Left</div>
                                        </div>
                                        <input type="file" id="iolv" name="iolv" accept="image/*" class="d-none" onchange="handleImageUpload(this, 'iolv')">
                                    </div>
                                    <div class="image-upload-item" onclick="triggerFileInput('iouv')">
                                        <i class="bi bi-camera display-6 text-muted mb-2"></i>
                                        <div class="text-center">
                                            <strong>Upper View</strong>
                                            <div class="text-muted small">Intra-oral Upper</div>
                                        </div>
                                        <input type="file" id="iouv" name="iouv" accept="image/*" class="d-none" onchange="handleImageUpload(this, 'iouv')">
                                    </div>
                                    <div class="image-upload-item" onclick="triggerFileInput('iolowerv')">
                                        <i class="bi bi-camera display-6 text-muted mb-2"></i>
                                        <div class="text-center">
                                            <strong>Lower View</strong>
                                            <div class="text-muted small">Intra-oral Lower</div>
                                        </div>
                                        <input type="file" id="iolowerv" name="iolowerv" accept="image/*" class="d-none" onchange="handleImageUpload(this, 'iolowerv')">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Section -->
                        <div class="text-center">
                            <button type="button" class="btn btn-outline-secondary btn-lg me-3" onclick="previousStep()">
                                <i class="bi bi-arrow-left me-2"></i>Previous
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="bi bi-file-earmark-pdf me-2"></i>Generate Case Report
                            </button>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="text-center mt-4" id="navigationButtons">
                        <button type="button" class="btn btn-primary btn-lg px-5" onclick="nextStep()" id="nextButton">
                            Next Step <i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        let currentStep = 1;
        let selectedVisitType = null;

        function selectVisitType(type) {
            selectedVisitType = type;
            
            // Remove selected class from all cards
            document.querySelectorAll('.visit-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            event.currentTarget.classList.add('selected');
            
            // Check the radio button
            document.getElementById(type).checked = true;
            
            // Update step indicator
            updateStepIndicator(1, 'completed');
            
            // Enable next button
            document.getElementById('nextButton').disabled = false;
        }

        function nextStep() {
            if (currentStep === 1 && !selectedVisitType) {
                alert('Please select a visit type first.');
                return;
            }
            
            if (currentStep < 4) {
                currentStep++;
                showCurrentStep();
                updateStepIndicator(currentStep, 'active');
                
                if (currentStep > 1) {
                    updateStepIndicator(currentStep - 1, 'completed');
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showCurrentStep();
                updateStepIndicator(currentStep, 'active');
                
                for (let i = currentStep + 1; i <= 4; i++) {
                    updateStepIndicator(i, '');
                }
            }
        }

        function showCurrentStep() {
            // Hide all sections
            document.querySelectorAll('.section-hidden, #visitTypeSection').forEach(section => {
                section.classList.remove('section-visible');
                section.classList.add('section-hidden');
            });
            
            // Show current step section
            let sectionToShow;
            switch(currentStep) {
                case 1:
                    sectionToShow = document.getElementById('visitTypeSection');
                    break;
                case 2:
                    sectionToShow = document.getElementById('patientSection');
                    
                    // Show appropriate patient fields based on visit type
                    if (selectedVisitType === 'registration') {
                        document.getElementById('registrationFields').style.display = 'block';
                        document.getElementById('followupFields').style.display = 'none';
                    } else {
                        document.getElementById('registrationFields').style.display = 'none';
                        document.getElementById('followupFields').style.display = 'block';
                    }
                    break;
                case 3:
                    sectionToShow = document.getElementById('caseDetailsSection');
                    break;
                case 4:
                    sectionToShow = document.getElementById('imageUploadSection');
                    document.getElementById('navigationButtons').style.display = 'none';
                    break;
            }
            
            if (sectionToShow) {
                sectionToShow.classList.remove('section-hidden');
                sectionToShow.classList.add('section-visible');
            }
        }

        function updateStepIndicator(stepNumber, status) {
            const step = document.getElementById(`step${stepNumber}`);
            step.className = `step ${status}`;
        }

        function triggerFileInput(inputId) {
            document.getElementById(inputId).click();
        }

        function handleImageUpload(input, containerId) {
            const container = input.parentElement;
            const file = input.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    container.innerHTML = `
                        <img src="${e.target.result}" class="image-preview" alt="Preview">
                        <div class="text-center">
                            <strong>${container.querySelector('strong').textContent}</strong>
                            <div class="text-success small">âœ“ Image uploaded</div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-1" onclick="removeImage('${inputId}')">
                            <i class="bi bi-x"></i>
                        </button>
                    `;
                    container.classList.add('has-image');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage(inputId) {
            const input = document.getElementById(inputId);
            const container = input.parentElement;
            
            input.value = '';
            container.classList.remove('has-image');
            
            // Reset container content
            const label = container.querySelector('strong').textContent;
            const subtitle = container.querySelector('.text-muted').textContent;
            
            container.innerHTML = `
                <i class="bi bi-camera display-6 text-muted mb-2"></i>
                <div class="text-center">
                    <strong>${label}</strong>
                    <div class="text-muted small">${subtitle}</div>
                </div>
                <input type="file" id="${inputId}" name="${inputId}" accept="image/*" class="d-none" onchange="handleImageUpload(this, '${inputId}')">
            `;
            
            container.onclick = () => triggerFileInput(inputId);
        }

        // Character counter for notes
        document.addEventListener('DOMContentLoaded', function() {
            const notesTextarea = document.getElementById('notes');
            const noteCount = document.getElementById('noteCount');
            
            if (notesTextarea && noteCount) {
                notesTextarea.addEventListener('input', function() {
                    noteCount.textContent = this.value.length;
                });
            }
        });

        // Search patients function
        function searchPatients() {
            const searchValue = document.getElementById('mrnSearch').value.trim();
            
            if (searchValue.length < 2) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }
            
            fetch('/search_patients', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ mrn: searchValue })
            })
            .then(response => response.json())
            .then(data => {
                displaySearchResults(data.patients || []);
            })
            .catch(error => {
                console.error('Search error:', error);
            });
        }

        function displaySearchResults(patients) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (patients.length === 0) {
                resultsContainer.innerHTML = '<div class="alert alert-warning">No patients found</div>';
                return;
            }
            
            let html = '<div class="list-group">';
            patients.forEach(patient => {
                html += `
                    <button type="button" class="list-group-item list-group-item-action" onclick="selectPatient(${patient.id}, '${patient.mrn}', '${patient.first_name}', '${patient.last_name}', '${patient.clinic}')">
                        <div class="fw-bold">${patient.first_name} ${patient.last_name}</div>
                        <small class="text-muted">MRN: ${patient.mrn} | Clinic: ${patient.clinic}</small>
                    </button>
                `;
            });
            html += '</div>';
            
            resultsContainer.innerHTML = html;
        }

        function selectPatient(id, mrn, firstName, lastName, clinic) {
            document.getElementById('selectedPatientId').value = id;
            document.getElementById('selectedPatientDetails').textContent = `${firstName} ${lastName} (MRN: ${mrn}, Clinic: ${clinic})`;
            document.getElementById('selectedPatientInfo').style.display = 'block';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('mrnSearch').value = mrn;
        }

        function clearSearch() {
            document.getElementById('mrnSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('selectedPatientInfo').style.display = 'none';
            document.getElementById('selectedPatientId').value = '';
        }
    </script>
</body>
</html>